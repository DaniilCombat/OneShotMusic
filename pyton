from flask import Flask, render_template, request, redirect, url_for, jsonify
import os
from config import *

app = Flask(__name__)
app.config["UPLOAD_FOLDER"] = UPLOAD_FOLDER
app.secret_key = SECRET_KEY

def allowed(filename):
    return "." in filename and filename.rsplit(".", 1)[1].lower() in ALLOWED_EXTENSIONS

@app.route("/")
def index():
    return render_template("index.html")

@app.route("/tracks")
def track_list():
    files = os.listdir(UPLOAD_FOLDER)
    tracks = [
        {"title": f.rsplit('.',1)[0], "src": url_for("music", name=f)}
        for f in files
    ]
    return jsonify(tracks)

@app.route("/music/<name>")
def music(name):
    return send_from_directory(UPLOAD_FOLDER, name)

@app.route("/admin", methods=["GET", "POST"])
def admin_panel():
    password = request.args.get("password")
    if password != ADMIN_PASSWORD:
        return "Access denied"

    if request.method == "POST":
        file = request.files.get("file")
        if file and allowed(file.filename):
            file.save(os.path.join(UPLOAD_FOLDER, file.filename))
            return redirect(url_for("admin_panel", password=ADMIN_PASSWORD))

    tracks = os.listdir(UPLOAD_FOLDER)
    return render_template("admin.html", tracks=tracks, admin_pass=ADMIN_PASSWORD)

@app.route("/delete/<name>")
def delete_track(name):
    password = request.args.get("password")
    if password != ADMIN_PASSWORD:
        return "Access denied"

    path = os.path.join(UPLOAD_FOLDER, name)
    if os.path.exists(path):
        os.remove(path)

    return redirect(url_for("admin_panel", password=ADMIN_PASSWORD))

if __name__ == "__main__":
    app.run(debug=True)
